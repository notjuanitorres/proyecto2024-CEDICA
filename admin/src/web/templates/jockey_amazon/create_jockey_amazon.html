{% extends "layout.html" %}

{% block title %} Jinetes y Amazonas - Agregar Jinete y Amazona {% endblock %}

{% block main_content %}
    <nav class="breadcrumb" aria-label="breadcrumbs">
        <ul>
            <li>
                <a href="{{ url_for('index_bp.home') }}">
                    <span class="icon is-small"><i class="fas fa-home" aria-hidden="true"></i></span>
                    <span>Inicio</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('jockey_amazon_bp.get_jockeys') }}">
                    <span class="icon is-small"><i class="fas fa-hat-cowboy" aria-hidden="true"></i></span>
                    <span>Jinetes y Amazonas</span>
                </a>
            </li>
            <li>
                <a href="">
                    <span class="icon is-small"><i class="fas fa-add" aria-hidden="true"></i></span>
                    <span>Agregar Jinetes y Amazonas</span>
                </a>
            </li>
        </ul>
    </nav>

    <h1 class="title">Agregar Jinete/Amazona</h1>
    
    <h3 class="subtitle is-size-4 my-2 mt-4 has-text-centered">
        Agregando {% block step_name %}{% endblock %}
    </h3>
    <progress class="progress is-success is-medium" value="{% block step_number %}{% endblock %}" max="5">
    </progress>
    
    <section class="section pt-0">

        <article id="{% block section_id %}{% endblock %}" class="container">
            <form method="POST">
                {% block step_form %}{% endblock %}
                <div class="field-body mt-5">
                    <div class="field">
                        <div class="control">
                            {% block prev_button %}{% endblock %}
                        </div>
                    </div>
                    <div class="field">
                        <div class="control">
                            {% block next_button %}{% endblock %}
                        </div>
                    </div>
                </div>
            </form>
        </article>
    </section>
{% endblock %}
{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
    // Toggle functionality for various form sections
    function setupToggle(checkboxSelector, detailsSelector) {
        const checkbox = document.querySelector(checkboxSelector);
        const details = document.getElementById(detailsSelector);

        function toggleDetails() {
            details.style.display = checkbox.checked ? 'block' : 'none';
        }
        if (checkbox) {
            checkbox.addEventListener('change', toggleDetails);
            toggleDetails(); // Initial check
        }
    }

    setupToggle('input[name="has_scholarship"]', 'scholarship-details');
    setupToggle('input[name="has_disability"]', 'disability-details');
    setupToggle('input[name="has_family_assignment"]', 'family-assignment-details');
    setupToggle('input[name="has_curatorship"]', 'curatorship-details');
    setupToggle('input[name="has_pension"]', 'pension-details');

    // Enhanced form validation logic
    const fields = {
        dni: { regex: /^\d{8}$/, errorMessage: 'El DNI debe contener exactamente 8 números' },
        first_name: { regex: /^[a-zA-Z\s]+$/, errorMessage: 'El nombre debe contener solo letras' },
        last_name: { regex: /^[a-zA-Z\s]+$/, errorMessage: 'El apellido debe contener solo letras' },
        birth_date: { regex: /^\d{4}-\d{2}-\d{2}$/, errorMessage: 'La fecha de nacimiento debe tener el formato YYYY-MM-DD' },
        birthplace: { regex: /^[a-zA-Z\s]+$/, errorMessage: 'El lugar de nacimiento debe contener solo letras' },
        'phone-country_code': { regex: /^\d{1,3}$/, errorMessage: 'El código de país debe contener como máximo 3 números' },
        'phone-area_code': { regex: /^\d{1,4}$/, errorMessage: 'El código de área debe contener como máximo 4 números' },
        'phone-number': { regex: /^\d+$/, errorMessage: 'El número de teléfono debe contener solo números' },
        'address-street': { regex: /^.+$/, errorMessage: 'La calle no puede estar vacía' },
        'address-number': { regex: /^\d+$/, errorMessage: 'El número debe contener solo números' },
        'address-department': { regex: /^[a-zA-Z0-9\s]+$/, errorMessage: 'El departamento de la institución escolar debe contener solo letras y números' },
        'address-locality': { regex: /^[a-zA-Z\s]+$/, errorMessage: 'La localidad debe contener solo letras' },
        'address-province': { regex: /^[a-zA-Z\s]+$/, errorMessage: 'La provincia debe contener solo letras' },
        'emergency_contact-emergency_contact_name': { regex: /^[a-zA-Z\s]+$/, errorMessage: 'El contacto de emergencia debe contener solo letras' },
        'emergency_contact-emergency_contact_phone': { regex: /^.+$/, errorMessage: 'El teléfono de contacto no puede estar vacío' },
        has_scholarship: { type: 'checkbox' },
        scholarship_observations: { regex: /^.{0,500}$/, errorMessage: 'Las observaciones de la beca no pueden exceder 500 caracteres' },
        scholarship_percentage: { regex: /^\d+(\.\d+)?$/, errorMessage: 'El porcentaje de la beca debe ser un número válido' },
        has_disability: { type: 'checkbox' },
        disability_diagnosis: { type: 'select' },
        disability_other: { regex: /^.{0,500}$/, errorMessage: 'La descripción de la discapacidad no puede exceder 500 caracteres' },
        disability_type: { type: 'select' },
        has_family_assignment: { type: 'checkbox' },
        family_assignment_type: { type: 'select' },
        has_pension: { type: 'checkbox' },
        pension_type: { type: 'select' },
        pension_details: { regex: /^.{0,500}$/, errorMessage: 'Los detalles de la pensión no pueden exceder 500 caracteres' },
        social_security: { regex: /^.{0,100}$/, errorMessage: 'La seguridad social no puede exceder 100 caracteres' },
        social_security_number: { regex: /^\d+$/, errorMessage: 'El número de seguridad social debe contener solo números' },
        has_curatorship: { type: 'checkbox' },
        curatorship_observations: { regex: /^.{0,500}$/, errorMessage: 'Las observaciones de la curaduría no pueden exceder 500 caracteres' },
        current_grade_year: { regex: /^.{0,100}$/, errorMessage: 'El grado/año actual no puede exceder 100 caracteres' },
        school_observations: { regex: /^.{0,500}$/, errorMessage: 'Las observaciones escolares no pueden exceder 500 caracteres' },
        professionals: { regex: /^.{0,500}$/, errorMessage: 'Los profesionales no pueden exceder 500 caracteres' },
        'school_institution-school_name': { regex: /^.+$/, errorMessage: 'El nombre de la institución escolar no puede estar vacío' },
        'school_institution-street': { regex: /^.+$/, errorMessage: 'La calle de la institución escolar no puede estar vacía' },
        'school_institution-number': { regex: /^\d+$/, errorMessage: 'El número de la institución escolar debe contener solo números' },
        'school_institution-department': { regex: /^[a-zA-Z0-9\s]+$/, errorMessage: 'El departamento de la institución escolar debe contener solo letras y números' },
        'school_institution-locality': { regex: /^[a-zA-Z\s]+$/, errorMessage: 'La localidad de la institución escolar debe contener solo letras' },
        'school_institution-province': { regex: /^[a-zA-Z\s]+$/, errorMessage: 'La provincia de la institución escolar debe contener solo letras' },
        'school_institution-phone_country_code': { regex: /^\d{1,3}$/, errorMessage: 'El código de país de la institución escolar debe contener como máximo 3 números' },
        'school_institution-phone_area_code': { regex: /^\d{1,4}$/, errorMessage: 'El código de área de la institución escolar debe contener como máximo 4 números' },
        'school_institution-phone_number': { regex: /^\d+$/, errorMessage: 'El número de teléfono de la institución escolar debe contener solo números' },
        'current_grade_year': { regex: /^.{1,100}$/, errorMessage: 'El grado/año actual no puede estar vacío y no debe exceder 100 caracteres' },
        'school_observations': { regex: /^.{0,500}$/, errorMessage: 'Las observaciones escolares no pueden exceder 500 caracteres' },
        'family_member1-relationship': { regex: /^[a-zA-Z\s]+$/, errorMessage: 'La relación debe contener solo letras' },
        'family_member1-first_name': { regex: /^[a-zA-Z\s]+$/, errorMessage: 'El nombre debe contener solo letras' },
        'family_member1-last_name': { regex: /^[a-zA-Z\s]+$/, errorMessage: 'El apellido debe contener solo letras' },
        'family_member1-dni': { regex: /^\d{8}$/, errorMessage: 'El DNI debe contener exactamente 8 números' },
        'family_member1-street': { regex: /^.+$/, errorMessage: 'La calle no puede estar vacía' },
        'family_member1-number': { regex: /^\d+$/, errorMessage: 'El número debe contener solo números' },
        'family_member1-department': { regex: /^[a-zA-Z0-9\s]+$/, errorMessage: 'El departamento de la institución escolar debe contener solo letras y números' },
        'family_member1-locality': { regex: /^[a-zA-Z\s]+$/, errorMessage: 'La localidad debe contener solo letras' },
        'family_member1-province': { regex: /^[a-zA-Z\s]+$/, errorMessage: 'La provincia debe contener solo letras' },
        'family_member1-phone_country_code': { regex: /^\d{1,3}$/, errorMessage: 'El código de país debe contener como máximo 3 números' },
        'family_member1-phone_area_code': { regex: /^\d{1,4}$/, errorMessage: 'El código de área debe contener como máximo 4 números' },
        'family_member1-phone_number': { regex: /^\d+$/, errorMessage: 'El número de teléfono debe contener solo números' },
        'family_member1-email': { regex: /^[^\s@]+@[^\s@]+\.[^\s@]+$/, errorMessage: 'Ingrese un correo electrónico válido' },
        'family_member1-education_level': { regex: /^.+$/, errorMessage: 'Seleccione un nivel educativo' },
        'family_member1-occupation': { regex: /^.+$/, errorMessage: 'La ocupación no puede estar vacía' },
        'family_member1-relationship': { regex: /^[a-zA-Z\s]+$/, errorMessage: 'La relación debe contener solo letras' },
        'family_member1-first_name': { regex: /^[a-zA-Z\s]+$/, errorMessage: 'El nombre debe contener solo letras' },
        'family_member1-last_name': { regex: /^[a-zA-Z\s]+$/, errorMessage: 'El apellido debe contener solo letras' },
        'family_member2-dni': { regex: /^\d{8}$/, errorMessage: 'El DNI debe contener exactamente 8 números' },
        'family_member2-street': { regex: /^.+$/, errorMessage: 'La calle no puede estar vacía' },
        'family_member2-number': { regex: /^\d+$/, errorMessage: 'El número debe contener solo números' },
        'family_member2-department': { regex: /^[a-zA-Z0-9\s]+$/, errorMessage: 'El departamento de la institución escolar debe contener solo letras y números' },
        'family_member2-locality': { regex: /^[a-zA-Z\s]+$/, errorMessage: 'La localidad debe contener solo letras' },
        'family_member2-province': { regex: /^[a-zA-Z\s]+$/, errorMessage: 'La provincia debe contener solo letras' },
        'family_member2-phone_country_code': { regex: /^\d{1,3}$/, errorMessage: 'El código de país debe contener como máximo 3 números' },
        'family_member2-phone_area_code': { regex: /^\d{1,4}$/, errorMessage: 'El código de área debe contener como máximo 4 números' },
        'family_member2-phone_number': { regex: /^\d+$/, errorMessage: 'El número de teléfono debe contener solo números' },
        'family_member2-email': { regex: /^[^\s@]+@[^\s@]+\.[^\s@]+$/, errorMessage: 'Ingrese un correo electrónico válido' },
        'family_member2-education_level': { regex: /^.+$/, errorMessage: 'Seleccione un nivel educativo' },
        'family_member2-occupation': { regex: /^.+$/, errorMessage: 'La ocupación no puede estar vacía' },
    };

    Object.keys(fields).forEach(fieldName => {
        const input = document.querySelector(`[name="${fieldName}"]`);
        if (input) {
            input.addEventListener('input', () => {
                validateField(input, fields[fieldName].regex, fields[fieldName].errorMessage);
            });
        }
    });

    // Updated validation function to handle nested fields
    function validateField(input, regex, errorMessage) {
        const isValid = regex.test(input.value);
        if (isValid) {
            setFieldValid(input);
        } else {
            setFieldInvalid(input, errorMessage);
        }
        return isValid;
    }

    // Helper function to get the input element for a field
    function getInputElement(fieldName) {
        // Check if it's a nested field
        if (fieldName.includes('-')) {
            const [parent, child] = fieldName.split('-');
            return document.querySelector(`[name="${parent}[${child}]"]`);
        }
        return document.querySelector(`[name="${fieldName}"]`);
    }

    // Set up validation for all fields
    Object.keys(fields).forEach(fieldName => {
        const input = getInputElement(fieldName);
        if (input) {
            input.addEventListener('input', () => {
                validateField(input, fields[fieldName].regex, fields[fieldName].errorMessage);
            });
        }
    });

    // Form submission handling
    const form = document.querySelector('form');
    form.addEventListener('submit', (event) => {
        let isValid = true;

        Object.keys(fields).forEach(fieldName => {
            const input = getInputElement(fieldName);
            if (input) {
                if (!validateField(input, fields[fieldName].regex, fields[fieldName].errorMessage)) {
                    isValid = false;
                }
            }
        });

        if (!isValid) {
            event.preventDefault();
            alert('Por favor, corrija los errores en el formulario antes de enviarlo.');
        }
    });

    // Helper functions (unchanged)
    function setFieldValid(input) {
        input.classList.remove('is-danger');
        input.classList.add('is-success');
        clearError(input);
    }

    function setFieldInvalid(input, errorMessage) {
        input.classList.remove('is-success');
        input.classList.add('is-danger');
        showError(input, errorMessage);
    }

    function showError(input, message) {
        let errorElement = input.nextElementSibling;
        if (!errorElement || !errorElement.classList.contains('help')) {
            errorElement = document.createElement('p');
            errorElement.className = 'help is-danger';
            input.parentNode.insertBefore(errorElement, input.nextSibling);
        }
        errorElement.textContent = message;
    }

    function clearError(input) {
        const errorElement = input.nextElementSibling;
        if (errorElement && errorElement.classList.contains('help')) {
            errorElement.remove();
        }
    }
});
</script>
{% endblock %}